{
  "$schema": "http://localhost:3001/schema/registry-item.json",
  "name": "media-uploader",
  "type": "registry:dynamic-component",
  "author": "axionjs (https://www.axionjs.com)",
  "description": "A media uploader with image and video support.",
  "dependencies": [
    "prisma",
    "@prisma/client",
    "cloudinary"
  ],
  "registryDependencies": [
    "button",
    "alert-dialog",
    "card",
    "progress"
  ],
  "files": [
    {
      "path": "dynamic-components/media-uploader/actions/media-actions.ts",
      "content": "\"use server\";\n\nimport { db } from \"@/registry/new-york/lib/db\";\nimport { v2 as cloudinary } from \"cloudinary\";\nimport { revalidatePath } from \"next/cache\";\n\n// Configure Cloudinary\ncloudinary.config({\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\n  api_key: process.env.CLOUDINARY_API_KEY,\n  api_secret: process.env.CLOUDINARY_API_SECRET,\n});\n\nexport async function uploadToCloudinary({\n  name,\n  type,\n  size,\n  base64,\n  isVideo,\n}: {\n  name: string;\n  type: string;\n  size: number;\n  base64: string;\n  isVideo: boolean;\n}) {\n  try {\n    // Create a unique public_id\n    const timestamp = new Date().getTime();\n    const publicId = `upload_${timestamp}_${name.replace(/\\.[^/.]+$/, \"\")}`;\n\n    let uploadResult;\n\n    if (isVideo) {\n      // For videos - note: Cloudinary might have size limits for direct uploads\n      uploadResult = await cloudinary.uploader.upload(\n        `data:${type};base64,${base64}`,\n        {\n          resource_type: \"video\",\n          public_id: publicId,\n          folder: \"videos\",\n        },\n      );\n    } else {\n      // For images\n      uploadResult = await cloudinary.uploader.upload(\n        `data:${type};base64,${base64}`,\n        {\n          public_id: publicId,\n          folder: \"images\",\n        },\n      );\n    }\n\n    // Create a record in the database\n    const mediaRecord = await db.media.create({\n      data: {\n        name,\n        size,\n        url: uploadResult.secure_url,\n        publicId: uploadResult.public_id,\n        thumbnailUrl: isVideo ? null : uploadResult.secure_url,\n        mediaType: isVideo ? \"VIDEO\" : \"IMAGE\",\n      },\n    });\n\n    revalidatePath(\"/media\");\n\n    return {\n      success: true,\n      mediaId: mediaRecord.id,\n      url: uploadResult.secure_url,\n      thumbnailUrl: isVideo ? null : uploadResult.secure_url,\n    };\n  } catch (error) {\n    console.error(\"Error uploading to Cloudinary:\", error);\n    throw new Error(\"Failed to upload media\");\n  }\n}\n\nexport async function getMedia() {\n  try {\n    const media = await db.media.findMany({\n      orderBy: {\n        createdAt: \"desc\",\n      },\n    });\n\n    return media;\n  } catch (error) {\n    console.error(\"Error fetching media:\", error);\n    throw new Error(\"Failed to fetch media\");\n  }\n}\n\nexport async function deleteMedia(id: string) {\n  try {\n    // Get the media record\n    const media = await db.media.findUnique({\n      where: { id },\n    });\n\n    if (!media) {\n      throw new Error(\"Media not found\");\n    }\n\n    // Delete from Cloudinary\n    if (media.publicId) {\n      await cloudinary.uploader.destroy(media.publicId, {\n        resource_type: media.mediaType === \"VIDEO\" ? \"video\" : \"image\",\n      });\n    }\n\n    // Delete from database\n    await db.media.delete({\n      where: { id },\n    });\n\n    // Revalidate paths\n    revalidatePath(\"/media\");\n\n    return { success: true };\n  } catch (error) {\n    console.error(\"Error deleting media:\", error);\n    throw new Error(\"Failed to delete media\");\n  }\n}\n",
      "type": "registry:actions",
      "target": ""
    },
    {
      "path": "lib/db.ts",
      "content": "import { PrismaClient } from \"@/lib/generated/prisma/client\";\n\ndeclare global {\n  var prisma: PrismaClient | undefined;\n}\nexport const db = globalThis.prisma || new PrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalThis.prisma = db;\n}\n",
      "type": "registry:lib",
      "target": ""
    },
    {
      "path": "dynamic-components/media-uploader/components/media-uploader.tsx",
      "content": "\"use client\";\n\nimport type React from \"react\";\nimport { useState, useRef } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Image from \"next/image\";\nimport {\n  Upload,\n  X,\n  CheckCircle,\n  AlertCircle,\n  ImageIcon,\n  Film,\n} from \"lucide-react\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport { Card, CardContent } from \"@/registry/new-york/ui/card\";\nimport { cn } from \"@/lib/utils\";\nimport { uploadToCloudinary } from \"@/registry/new-york/dynamic-components/media-uploader/actions/media-actions\";\nimport { Progress } from \"@/registry/new-york/ui/progress\";\n\ntype FileStatus = \"idle\" | \"uploading\" | \"success\" | \"error\";\n\ninterface FileWithStatus {\n  file: File;\n  id: string;\n  progress: number;\n  status: FileStatus;\n  url?: string;\n  thumbnailUrl?: string;\n  isVideo: boolean;\n}\n\nexport function MediaUploader() {\n  const [files, setFiles] = useState<FileWithStatus[]>([]);\n  const [isDragging, setIsDragging] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const router = useRouter();\n\n  const handleFileChange = (selectedFiles: FileList | null) => {\n    if (!selectedFiles) return;\n\n    const newFiles = Array.from(selectedFiles)\n      .filter((file) => {\n        // Filter for image and video file types\n        const fileType = file.type;\n        return fileType.includes(\"image\") || fileType.includes(\"video\");\n      })\n      .map((file) => ({\n        file,\n        id: crypto.randomUUID(),\n        progress: 0,\n        status: \"idle\" as FileStatus,\n        isVideo: file.type.includes(\"video\"),\n      }));\n\n    setFiles((prev) => [...prev, ...newFiles]);\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = () => {\n    setIsDragging(false);\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n    handleFileChange(e.dataTransfer.files);\n  };\n\n  const handleUpload = async (fileWithStatus: FileWithStatus) => {\n    try {\n      // Update status to uploading\n      setFiles((prev) =>\n        prev.map((f) =>\n          f.id === fileWithStatus.id ? { ...f, status: \"uploading\" } : f,\n        ),\n      );\n\n      // Convert file to base64 for Server Action\n      const reader = new FileReader();\n      const base64 = await new Promise((resolve) => {\n        reader.onload = () => resolve(reader.result);\n        reader.readAsDataURL(fileWithStatus.file);\n      });\n\n      // Simulate progress updates\n      const steps = 10;\n      for (let i = 1; i <= steps; i++) {\n        await new Promise((resolve) => setTimeout(resolve, 100));\n        setFiles((prev) =>\n          prev.map((f) =>\n            f.id === fileWithStatus.id\n              ? { ...f, progress: (i / steps) * 100 }\n              : f,\n          ),\n        );\n      }\n\n      // Call server action with base64 data\n      const result = await uploadToCloudinary({\n        name: fileWithStatus.file.name,\n        type: fileWithStatus.file.type,\n        size: fileWithStatus.file.size,\n        base64: (base64 as string).split(\",\")[1],\n        isVideo: fileWithStatus.isVideo,\n      });\n\n      // Update status based on result\n      setFiles((prev) =>\n        prev.map((f) =>\n          f.id === fileWithStatus.id\n            ? {\n                ...f,\n                status: \"success\",\n                progress: 100,\n                url: result.url,\n                thumbnailUrl: result.thumbnailUrl || result.url,\n              }\n            : f,\n        ),\n      );\n\n      router.refresh();\n    } catch (error) {\n      console.error(\"Upload failed:\", error);\n      setFiles((prev) =>\n        prev.map((f) =>\n          f.id === fileWithStatus.id ? { ...f, status: \"error\" } : f,\n        ),\n      );\n    }\n  };\n\n  const removeFile = (id: string) => {\n    setFiles((prev) => prev.filter((f) => f.id !== id));\n  };\n\n  return (\n    <Card className=\"w-full\">\n      <CardContent className=\"p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-lg font-semibold\">Media Upload</h3>\n          <p className=\"text-sm text-muted-foreground\">\n            Supported formats: JPG, PNG, GIF, WebP, MP4, WebM\n          </p>\n        </div>\n\n        <div\n          className={cn(\n            \"border-2 border-dashed rounded-lg p-10 text-center cursor-pointer transition-colors\",\n            isDragging\n              ? \"border-primary bg-primary/5\"\n              : \"border-gray-300 hover:border-primary\",\n          )}\n          onDragOver={handleDragOver}\n          onDragLeave={handleDragLeave}\n          onDrop={handleDrop}\n          onClick={() => fileInputRef.current?.click()}\n        >\n          <input\n            type=\"file\"\n            ref={fileInputRef}\n            onChange={(e) => handleFileChange(e.target.files)}\n            className=\"hidden\"\n            multiple\n            accept=\"image/*,video/*\"\n          />\n          <div className=\"flex flex-col items-center justify-center space-y-2\">\n            <Upload className=\"h-10 w-10 text-muted-foreground\" />\n            <h3 className=\"text-lg font-semibold\">\n              Drag and drop your media here\n            </h3>\n            <p className=\"text-sm text-muted-foreground\">\n              or click to browse your computer\n            </p>\n          </div>\n        </div>\n\n        {files.length > 0 && (\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-medium\">Media ({files.length})</h3>\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-5 gap-4\">\n              {files.map((fileWithStatus) => (\n                <div\n                  key={fileWithStatus.id}\n                  className=\"relative border rounded-lg overflow-hidden\"\n                >\n                  <div className=\"aspect-square relative bg-gray-100\">\n                    {fileWithStatus.status === \"success\" &&\n                    fileWithStatus.thumbnailUrl ? (\n                      <>\n                        <Image\n                          src={\n                            fileWithStatus.thumbnailUrl || \"/placeholder.svg\"\n                          }\n                          alt={fileWithStatus.file.name}\n                          fill\n                          className=\"object-cover\"\n                        />\n                        {fileWithStatus.isVideo && (\n                          <div className=\"absolute inset-0 flex items-center justify-center bg-black/30\">\n                            <Film className=\"h-10 w-10 text-white\" />\n                          </div>\n                        )}\n                      </>\n                    ) : (\n                      <div className=\"flex items-center justify-center h-full\">\n                        {fileWithStatus.isVideo ? (\n                          <Film className=\"h-16 w-16 text-gray-400\" />\n                        ) : (\n                          <ImageIcon className=\"h-16 w-16 text-gray-400\" />\n                        )}\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"p-3\">\n                    <p className=\"font-medium truncate\">\n                      {fileWithStatus.file.name}\n                    </p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {(fileWithStatus.file.size / 1024 / 1024).toFixed(2)} MB\n                    </p>\n\n                    <div className=\"mt-2\">\n                      {fileWithStatus.status === \"idle\" && (\n                        <Button\n                          size=\"sm\"\n                          className=\"w-full\"\n                          onClick={() => handleUpload(fileWithStatus)}\n                        >\n                          Upload\n                        </Button>\n                      )}\n\n                      {fileWithStatus.status === \"uploading\" && (\n                        <div className=\"w-full\">\n                          <Progress\n                            value={fileWithStatus.progress}\n                            className=\"h-2\"\n                          />\n                          <p className=\"text-xs text-right mt-1\">\n                            {Math.round(fileWithStatus.progress)}%\n                          </p>\n                        </div>\n                      )}\n\n                      {fileWithStatus.status === \"success\" && (\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center space-x-1\">\n                            <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                            <span className=\"text-xs text-green-500\">\n                              Uploaded\n                            </span>\n                          </div>\n                          {fileWithStatus.url && (\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              asChild\n                              className=\"ml-2\"\n                            >\n                              <a\n                                href={fileWithStatus.url}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                              >\n                                View\n                              </a>\n                            </Button>\n                          )}\n                        </div>\n                      )}\n\n                      {fileWithStatus.status === \"error\" && (\n                        <div className=\"flex items-center space-x-1\">\n                          <AlertCircle className=\"h-4 w-4 text-red-500\" />\n                          <span className=\"text-xs text-red-500\">Failed</span>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"absolute top-2 right-2 bg-black/50 text-white hover:bg-black/70 rounded-full p-1 h-7 w-7\"\n                    onClick={() => removeFile(fileWithStatus.id)}\n                  >\n                    <X className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n",
      "type": "registry:component",
      "target": ""
    },
    {
      "path": "dynamic-components/media-uploader/components/media-gallery.tsx",
      "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport Image from \"next/image\";\nimport { Film, Trash2 } from \"lucide-react\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport { deleteMedia } from \"@/registry/new-york/dynamic-components/media-uploader/actions/media-actions\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/registry/new-york/ui/alert-dialog\";\n\ninterface Media {\n  id: string;\n  name: string;\n  url: string;\n  thumbnailUrl: string | null;\n  mediaType: \"IMAGE\" | \"VIDEO\";\n  createdAt: Date;\n}\n\ninterface MediaGalleryProps {\n  media: Media[];\n}\n\nexport function MediaGallery({ media: initialMedia }: MediaGalleryProps) {\n  const [media, setMedia] = useState<Media[]>(initialMedia);\n  const [mediaToDelete, setMediaToDelete] = useState<string | null>(null);\n\n  const handleDelete = async () => {\n    if (!mediaToDelete) return;\n\n    try {\n      await deleteMedia(mediaToDelete);\n      setMedia(media.filter((item) => item.id !== mediaToDelete));\n      setMediaToDelete(null);\n    } catch (error) {\n      console.error(\"Error deleting media:\", error);\n    }\n  };\n\n  if (media.length === 0) {\n    return (\n      <div className=\"text-center p-10 border rounded-lg\">\n        <p className=\"text-muted-foreground\">No media uploaded yet</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6\">\n      {media.map((item) => (\n        <div\n          key={item.id}\n          className=\"group relative border rounded-lg overflow-hidden\"\n        >\n          <div className=\"aspect-square relative bg-gray-100\">\n            <Image\n              src={item.thumbnailUrl || item.url}\n              alt={item.name}\n              fill\n              className=\"object-cover\"\n            />\n            {item.mediaType === \"VIDEO\" && (\n              <div className=\"absolute inset-0 flex items-center justify-center bg-black/30\">\n                <Film className=\"h-10 w-10 text-white\" />\n              </div>\n            )}\n          </div>\n\n          <div className=\"p-3\">\n            <p className=\"font-medium truncate\">{item.name}</p>\n            <p className=\"text-sm text-muted-foreground\">\n              {new Date(item.createdAt).toLocaleDateString()}\n            </p>\n\n            <div className=\"mt-2 flex justify-between\">\n              <Button variant=\"outline\" size=\"sm\" asChild>\n                <a href={item.url} target=\"_blank\" rel=\"noopener noreferrer\">\n                  View\n                </a>\n              </Button>\n\n              <AlertDialog\n                open={mediaToDelete === item.id}\n                onOpenChange={(open) => !open && setMediaToDelete(null)}\n              >\n                <AlertDialogTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    size=\"icon\"\n                    className=\"text-red-500 hover:text-red-600\"\n                    onClick={() => setMediaToDelete(item.id)}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </AlertDialogTrigger>\n                <AlertDialogContent>\n                  <AlertDialogHeader>\n                    <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n                    <AlertDialogDescription>\n                      This will permanently delete the media. This action cannot\n                      be undone.\n                    </AlertDialogDescription>\n                  </AlertDialogHeader>\n                  <AlertDialogFooter>\n                    <AlertDialogCancel>Cancel</AlertDialogCancel>\n                    <AlertDialogAction\n                      onClick={handleDelete}\n                      className=\"bg-red-500 hover:bg-red-600\"\n                    >\n                      Delete\n                    </AlertDialogAction>\n                  </AlertDialogFooter>\n                </AlertDialogContent>\n              </AlertDialog>\n            </div>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n",
      "type": "registry:component",
      "target": ""
    },
    {
      "path": "dynamic-components/media-uploader/media/page.tsx",
      "content": "import { getMedia } from \"@/registry/new-york/dynamic-components/media-uploader/actions/media-actions\";\nimport { MediaGallery } from \"@/registry/new-york/dynamic-components/media-uploader/components/media-gallery\";\n\nexport default async function MediaPage() {\n  const media = await getMedia();\n\n  return (\n    <div className=\"container mx-auto py-10\">\n      <h1 className=\"text-3xl font-bold mb-6\">Media Gallery</h1>\n      <MediaGallery media={media} />\n    </div>\n  );\n}\n",
      "type": "registry:page",
      "target": "app/(media-uploader)/media/page.tsx"
    }
  ]
}