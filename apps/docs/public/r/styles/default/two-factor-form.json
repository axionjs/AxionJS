{
  "$schema": "http://localhost:3001/schema/registry-item.json",
  "name": "two-factor-form",
  "type": "registry:dynamic-component",
  "author": "axionjs (https://www.axionjs.com)",
  "description": "A social authentication component that allows users to log in using OAuth provider (Github).",
  "dependencies": [
    "nodemailer",
    "prisma",
    "@prisma/client"
  ],
  "registryDependencies": [
    "button",
    "card",
    "alert",
    "form",
    "input",
    "label"
  ],
  "files": [
    {
      "path": "dynamic-components/two-factor-form/actions/two-factor-actions.ts",
      "content": "\"use server\";\n\nimport * as z from \"zod\";\nimport crypto from \"crypto\";\nimport { sendTwoFactorTokenEmail } from \"@/registry/default/dynamic-components/two-factor-form/lib/two-factor-utils\";\nimport { db } from \"@/registry/default/lib/db\";\n\n// Validation schemas\nconst TwoFactorRequestSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n});\n\nconst TwoFactorVerifySchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  code: z\n    .string()\n    .min(6, \"Code must be 6 digits\")\n    .max(6, \"Code must be 6 digits\"),\n});\n\nexport interface TwoFactorActionResult {\n  success?: string;\n  error?: string;\n  twoFactorRequired?: boolean;\n}\n\nexport interface TwoFactorToken {\n  id: string;\n  email: string;\n  token: string;\n  expires: Date;\n}\n\nexport interface TwoFactorConfirmation {\n  id: string;\n  userId: string;\n}\n// Request 2FA code\nexport const requestTwoFactorCode = async (\n  values: z.infer<typeof TwoFactorRequestSchema>,\n): Promise<TwoFactorActionResult> => {\n  try {\n    const validatedFields = TwoFactorRequestSchema.safeParse(values);\n\n    if (!validatedFields.success) {\n      return { error: \"Invalid email address\" };\n    }\n\n    const { email } = validatedFields.data;\n\n    // Generate and send 2FA token\n    const twoFactorToken = await generateTwoFactorToken(email);\n    await sendTwoFactorTokenEmail(email, twoFactorToken.token);\n\n    return {\n      success: \"Verification code sent to your email\",\n      twoFactorRequired: true,\n    };\n  } catch (error) {\n    console.error(\"2FA request error:\", error);\n    return { error: \"Failed to send verification code\" };\n  }\n};\n\n// Verify 2FA code\nexport const verifyTwoFactorCode = async (\n  values: z.infer<typeof TwoFactorVerifySchema>,\n): Promise<TwoFactorActionResult> => {\n  try {\n    const validatedFields = TwoFactorVerifySchema.safeParse(values);\n\n    if (!validatedFields.success) {\n      return { error: \"Invalid input\" };\n    }\n\n    const { email, code } = validatedFields.data;\n\n    // Get the token from database\n    const twoFactorToken = await getTwoFactorTokenByEmail(email);\n\n    if (!twoFactorToken) {\n      return { error: \"Invalid or expired code\" };\n    }\n\n    if (twoFactorToken.token !== code) {\n      return { error: \"Invalid verification code\" };\n    }\n\n    const hasExpired = new Date(twoFactorToken.expires) < new Date();\n    if (hasExpired) {\n      return { error: \"Verification code has expired\" };\n    }\n\n    // Clean up the token after successful verification\n    await db.twoFactorToken.delete({\n      where: { id: twoFactorToken.id },\n    });\n\n    return { success: \"Two-factor authentication verified successfully\" };\n  } catch (error) {\n    console.error(\"2FA verification error:\", error);\n    return { error: \"Verification failed\" };\n  }\n};\n\n// Enable/Disable 2FA for a user\nexport const toggleTwoFactor = async (\n  userId: string,\n  enabled: boolean,\n): Promise<TwoFactorActionResult> => {\n  try {\n    await db.user.update({\n      where: { id: userId },\n      data: { isTwoFactorEnabled: enabled },\n    });\n\n    if (!enabled) {\n      // Remove any existing 2FA confirmations when disabling\n      const existingConfirmation =\n        await getTwoFactorConfirmationByUserId(userId);\n      if (existingConfirmation) {\n        await db.twoFactorConfirmation.delete({\n          where: { id: existingConfirmation.id },\n        });\n      }\n    }\n\n    return {\n      success: `Two-factor authentication ${enabled ? \"enabled\" : \"disabled\"} successfully`,\n    };\n  } catch (error) {\n    return { error: \"Failed to update two-factor authentication settings\" };\n  }\n};\n\n// Database operations using Prisma\nexport const getTwoFactorTokenByToken = async (\n  token: string,\n): Promise<TwoFactorToken | null> => {\n  try {\n    const twoFactorToken = await db.twoFactorToken.findUnique({\n      where: { token },\n    });\n    return twoFactorToken;\n  } catch {\n    return null;\n  }\n};\n\nexport const getTwoFactorTokenByEmail = async (\n  email: string,\n): Promise<TwoFactorToken | null> => {\n  try {\n    const twoFactorToken = await db.twoFactorToken.findFirst({\n      where: { email },\n    });\n    return twoFactorToken;\n  } catch {\n    return null;\n  }\n};\n\nexport const getTwoFactorConfirmationByUserId = async (\n  userId: string,\n): Promise<TwoFactorConfirmation | null> => {\n  try {\n    const twoFactorConfirmation = await db.twoFactorConfirmation.findUnique({\n      where: { userId },\n    });\n    return twoFactorConfirmation;\n  } catch {\n    return null;\n  }\n};\n\nexport const generateTwoFactorToken = async (\n  email: string,\n): Promise<TwoFactorToken> => {\n  const token = crypto.randomInt(100_000, 1_000_000).toString();\n  const expires = new Date(new Date().getTime() + 5 * 60 * 1000); // 5 minute expiry\n\n  // Delete existing token if any\n  const existingToken = await getTwoFactorTokenByEmail(email);\n  if (existingToken) {\n    await db.twoFactorToken.delete({\n      where: { id: existingToken.id },\n    });\n  }\n\n  // Create new token\n  const twoFactorToken = await db.twoFactorToken.create({\n    data: {\n      email,\n      token,\n      expires,\n    },\n  });\n\n  return twoFactorToken;\n};\n",
      "type": "registry:actions",
      "target": ""
    },
    {
      "path": "lib/db.ts",
      "content": "import { PrismaClient } from \"@/lib/generated/prisma/client\";\n\ndeclare global {\n  var prisma: PrismaClient | undefined;\n}\nexport const db = globalThis.prisma || new PrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalThis.prisma = db;\n}\n",
      "type": "registry:lib",
      "target": ""
    },
    {
      "path": "dynamic-components/two-factor-form/components/two-factor-form.tsx",
      "content": "\"use client\";\n\nimport { useState, useTransition } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport * as z from \"zod\";\nimport { Button } from \"@/registry/default/ui/button\";\nimport { Input } from \"@/registry/default/ui/input\";\nimport { Label } from \"@/registry/default/ui/label\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/registry/default/ui/card\";\nimport { Alert, AlertDescription } from \"@/registry/default/ui/alert\";\nimport { Loader2, Shield, Mail } from \"lucide-react\";\nimport {\n  requestTwoFactorCode,\n  verifyTwoFactorCode,\n} from \"@/registry/default/dynamic-components/two-factor-form/actions/two-factor-actions\";\n\n// Validation schemas\nconst EmailSchema = z.object({\n  email: z.string().email(\"Please enter a valid email address\"),\n});\n\nconst VerificationSchema = z.object({\n  code: z\n    .string()\n    .min(6, \"Code must be 6 digits\")\n    .max(6, \"Code must be 6 digits\"),\n});\n\ninterface TwoFactorFormProps {\n  onSuccess?: (email: string) => void;\n  onError?: (error: string) => void;\n  title?: string;\n  description?: string;\n  className?: string;\n}\n\nexport function TwoFactorForm({\n  onSuccess,\n  onError,\n  title = \"Two-Factor Authentication\",\n  description = \"Enter your email to receive a verification code\",\n  className = \"\",\n}: TwoFactorFormProps) {\n  const [step, setStep] = useState<\"email\" | \"verification\">(\"email\");\n  const [email, setEmail] = useState(\"\");\n  const [message, setMessage] = useState<{\n    type: \"success\" | \"error\";\n    text: string;\n  } | null>(null);\n  const [isPending, startTransition] = useTransition();\n\n  const emailForm = useForm<z.infer<typeof EmailSchema>>({\n    resolver: zodResolver(EmailSchema),\n    defaultValues: {\n      email: \"\",\n    },\n  });\n\n  const verificationForm = useForm<z.infer<typeof VerificationSchema>>({\n    resolver: zodResolver(VerificationSchema),\n    defaultValues: {\n      code: \"\",\n    },\n  });\n\n  const handleEmailSubmit = (values: z.infer<typeof EmailSchema>) => {\n    setMessage(null);\n\n    startTransition(async () => {\n      try {\n        const result = await requestTwoFactorCode(values);\n\n        if (result.error) {\n          setMessage({ type: \"error\", text: result.error });\n          onError?.(result.error);\n        } else if (result.success) {\n          setMessage({ type: \"success\", text: result.success });\n          setEmail(values.email);\n          setStep(\"verification\");\n        }\n      } catch (error) {\n        const errorMessage = \"Something went wrong. Please try again.\";\n        setMessage({ type: \"error\", text: errorMessage });\n        onError?.(errorMessage);\n      }\n    });\n  };\n\n  const handleVerificationSubmit = (\n    values: z.infer<typeof VerificationSchema>,\n  ) => {\n    setMessage(null);\n\n    startTransition(async () => {\n      try {\n        const result = await verifyTwoFactorCode({\n          email,\n          code: values.code,\n        });\n\n        if (result.error) {\n          setMessage({ type: \"error\", text: result.error });\n          onError?.(result.error);\n        } else if (result.success) {\n          setMessage({ type: \"success\", text: result.success });\n          onSuccess?.(email);\n        }\n      } catch (error) {\n        const errorMessage = \"Verification failed. Please try again.\";\n        setMessage({ type: \"error\", text: errorMessage });\n        onError?.(errorMessage);\n      }\n    });\n  };\n\n  const resetForm = () => {\n    setStep(\"email\");\n    setEmail(\"\");\n    setMessage(null);\n    emailForm.reset();\n    verificationForm.reset();\n  };\n\n  return (\n    <Card className={className}>\n      <CardHeader className=\"text-center\">\n        <div className=\"mx-auto mb-2 flex h-12 w-12 items-center justify-center rounded-full bg-blue-100\">\n          <Shield className=\"h-6 w-6 text-blue-600\" />\n        </div>\n        <CardTitle>{title}</CardTitle>\n        <CardDescription>\n          {step === \"email\"\n            ? description\n            : `Enter the 6-digit code sent to ${email}`}\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {message && (\n          <Alert variant={message.type === \"error\" ? \"destructive\" : \"default\"}>\n            <AlertDescription>{message.text}</AlertDescription>\n          </Alert>\n        )}\n\n        {step === \"email\" ? (\n          <form\n            onSubmit={emailForm.handleSubmit(handleEmailSubmit)}\n            className=\"space-y-4\"\n          >\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email Address</Label>\n              <div className=\"relative\">\n                <Mail className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"Enter your email\"\n                  className=\"pl-10\"\n                  disabled={isPending}\n                  {...emailForm.register(\"email\")}\n                />\n              </div>\n              {emailForm.formState.errors.email && (\n                <p className=\"text-sm text-red-600\">\n                  {emailForm.formState.errors.email.message}\n                </p>\n              )}\n            </div>\n            <Button type=\"submit\" className=\"w-full\" disabled={isPending}>\n              {isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Sending Code...\n                </>\n              ) : (\n                \"Send Verification Code\"\n              )}\n            </Button>\n          </form>\n        ) : (\n          <form\n            onSubmit={verificationForm.handleSubmit(handleVerificationSubmit)}\n            className=\"space-y-4\"\n          >\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"code\">Verification Code</Label>\n              <Input\n                id=\"code\"\n                type=\"text\"\n                placeholder=\"Enter 6-digit code\"\n                maxLength={6}\n                className=\"text-center text-lg tracking-widest\"\n                disabled={isPending}\n                {...verificationForm.register(\"code\")}\n              />\n              {verificationForm.formState.errors.code && (\n                <p className=\"text-sm text-red-600\">\n                  {verificationForm.formState.errors.code.message}\n                </p>\n              )}\n            </div>\n            <div className=\"space-y-2\">\n              <Button type=\"submit\" className=\"w-full\" disabled={isPending}>\n                {isPending ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Verifying...\n                  </>\n                ) : (\n                  \"Verify Code\"\n                )}\n              </Button>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                className=\"w-full\"\n                onClick={resetForm}\n                disabled={isPending}\n              >\n                Use Different Email\n              </Button>\n            </div>\n          </form>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n",
      "type": "registry:component",
      "target": ""
    },
    {
      "path": "dynamic-components/two-factor-form/lib/two-factor-utils.ts",
      "content": "import nodemailer from \"nodemailer\";\nimport { getTwoFactorEmailTemplate } from \"@/registry/default/dynamic-components/two-factor-form/emails/two-factor-template\";\n\n// Email sending function - Complete implementation with template\nexport const sendTwoFactorTokenEmail = async (\n  email: string,\n  token: string,\n): Promise<void> => {\n  try {\n    // Create transporter based on environment variables\n    const transporter = nodemailer.createTransport({\n      host: process.env.EMAIL_SERVER_HOST,\n      port: Number(process.env.EMAIL_SERVER_PORT) || 587,\n      secure: Number(process.env.EMAIL_SERVER_PORT) === 465, // true for 465, false for other ports\n      auth: {\n        user: process.env.EMAIL_SERVER_USER,\n        pass: process.env.EMAIL_SERVER_PASSWORD,\n      },\n    });\n\n    // Get email templates\n    const { html, text } = getTwoFactorEmailTemplate(token);\n\n    // Send email\n    await transporter.sendMail({\n      from: `${process.env.EMAIL_FROM || \"AxionJS Team\"}`,\n      to: email,\n      subject: \"🔐 Your Two-Factor Authentication Code\",\n      text,\n      html,\n    });\n\n    console.log(`2FA code sent successfully to ${email}`);\n  } catch (error) {\n    console.error(\"Failed to send 2FA email:\", error);\n    throw new Error(\"Failed to send verification email\");\n  }\n};\n",
      "type": "registry:lib",
      "target": ""
    },
    {
      "path": "dynamic-components/two-factor-form/emails/two-factor-template.tsx",
      "content": "export const getTwoFactorEmailTemplate = (token: string) => {\n  const html = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <title>Two-Factor Authentication Code</title>\n          <style>\n            body { \n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; \n              line-height: 1.6; \n              color: #333; \n              margin: 0; \n              padding: 0; \n              background-color: #f5f5f5; \n            }\n            .container { \n              max-width: 600px; \n              margin: 40px auto; \n              background: white; \n              border-radius: 12px; \n              overflow: hidden; \n              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); \n            }\n            .header { \n              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); \n              color: white; \n              padding: 40px 30px; \n              text-align: center; \n            }\n            .header h1 { \n              margin: 0; \n              font-size: 28px; \n              font-weight: 600; \n            }\n            .content { \n              padding: 40px 30px; \n            }\n            .code-container { \n              text-align: center; \n              margin: 30px 0; \n            }\n            .code { \n              display: inline-block;\n              font-size: 36px; \n              font-weight: bold; \n              padding: 20px 30px; \n              background: #f8f9fa; \n              border: 2px dashed #dee2e6;\n              border-radius: 12px; \n              letter-spacing: 8px; \n              color: #495057;\n              font-family: 'Courier New', monospace;\n            }\n            .info { \n              background: #e3f2fd; \n              border-left: 4px solid #2196f3; \n              padding: 15px 20px; \n              margin: 25px 0; \n              border-radius: 4px; \n            }\n            .warning { \n              background: #fff3e0; \n              border-left: 4px solid #ff9800; \n              padding: 15px 20px; \n              margin: 25px 0; \n              border-radius: 4px; \n            }\n            .footer { \n              background: #f8f9fa; \n              padding: 20px 30px; \n              text-align: center; \n              font-size: 14px; \n              color: #6c757d; \n              border-top: 1px solid #e9ecef; \n            }\n            .btn {\n              display: inline-block;\n              padding: 12px 24px;\n              background: #007bff;\n              color: white;\n              text-decoration: none;\n              border-radius: 6px;\n              font-weight: 500;\n              margin: 20px 0;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>🔐 Two-Factor Authentication</h1>\n              <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Secure your account with this verification code</p>\n            </div>\n            <div class=\"content\">\n              <h2 style=\"color: #333; margin-top: 0;\">Your Verification Code</h2>\n              <p>Enter the following code to complete your two-factor authentication:</p>\n              \n              <div class=\"code-container\">\n                <div class=\"code\">${token}</div>\n              </div>\n              \n              <div class=\"info\">\n                <strong>⏰ Time Sensitive:</strong> This code will expire in <strong>5 minutes</strong> for your security.\n              </div>\n              \n              <div class=\"warning\">\n                <strong>🛡️ Security Notice:</strong> If you didn't request this code, please ignore this email and consider changing your password. Never share this code with anyone.\n              </div>\n              \n              <p style=\"margin-top: 30px;\">\n                Having trouble? Make sure you're entering the code exactly as shown above, including any spaces or dashes.\n              </p>\n            </div>\n            <div class=\"footer\">\n              <p>This is an automated security message from your application.</p>\n              <p>Please do not reply to this email.</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n\n  const text = `\n  Two-Factor Authentication Code\n  \n  Your verification code is: ${token}\n  \n  This code will expire in 5 minutes for security reasons.\n  \n  Security Notice: If you didn't request this code, please ignore this email and consider changing your password. Never share this code with anyone.\n  \n  Having trouble? Make sure you're entering the code exactly as shown above.\n  \n  This is an automated security message. Please do not reply to this email.\n    `;\n\n  return { html, text };\n};\n",
      "type": "registry:email",
      "target": ""
    },
    {
      "path": "dynamic-components/two-factor-form/twoFA/page.tsx",
      "content": "\"use client\";\nimport { TwoFactorForm } from \"@/registry/default/dynamic-components/two-factor-form/components/two-factor-form\";\n\nexport default function TwoFA() {\n  return (\n    <div className=\"min-h-screen bg-gray-50 py-12\">\n      <div className=\"mx-auto max-w-xl px-4\">\n        <div className=\"grid gap-8\">\n          <div className=\"space-y-4\">\n            <h2 className=\"text-xl font-semibold text-gray-800\">\n              Two-Factor Authentication\n            </h2>\n            <TwoFactorForm\n              onSuccess={(email) => {\n                console.log(\"2FA Success for:\", email);\n              }}\n              onError={(error) => {}}\n            />\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:page",
      "target": "app/(two-factor-form)/twoFA/page.tsx"
    }
  ]
}